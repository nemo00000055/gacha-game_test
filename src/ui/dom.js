export const $=(s,c=document)=>c.querySelector(s);export const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));export function on(e,t,h,o){e.addEventListener(t,h,o);return()=>e.removeEventListener(t,h,o)}const FOCUSABLE=['a[href]','area[href]','button:not([disabled])','input:not([disabled])','select:not([disabled])','textarea:not([disabled])','[tabindex]:not([tabindex="-1"])'].join(',');let modalStack=[];function getFocusable(c){return $$(FOCUSABLE,c).filter(el=>el.offsetParent!==null||el===document.activeElement)}export function trapFocus(m){const f=()=>getFocusable(m);function loop(e){if(e.key!=='Tab')return;const n=f();if(!n.length)return;const first=n[0],last=n[n.length-1];if(e.shiftKey&&document.activeElement===first){e.preventDefault();last.focus()}else if(!e.shiftKey&&document.activeElement===last){e.preventDefault();first.focus()}}on(m,'keydown',loop);return()=>m.removeEventListener('keydown',loop)}export function openModal(m,opener=null){if(!m||!m.hasAttribute('role'))return;if(!m.dataset.opener&&opener)m.dataset.opener=opener.id||'opener-temp';m.hidden=false;m.setAttribute('aria-hidden','false');modalStack.push(m);const release=trapFocus(m);m.dataset.trap='1';const toFocus=getFocusable(m)[0]||m.querySelector('.modal__close');setTimeout(()=>toFocus?.focus(),0);$$('.modal__backdrop,[data-action="close"]',m).forEach(el=>{on(el,'click',()=>closeModal(m))});m._releaseFocus=release}export function closeModal(m){if(!m||m.hidden)return;m.hidden=true;m.setAttribute('aria-hidden','true');modalStack=modalStack.filter(x=>x!==m);if(m._releaseFocus)m._releaseFocus();const openerId=m.dataset.opener;if(openerId)document.getElementById(openerId)?.focus()}export function closeTopModal(){const top=modalStack[modalStack.length-1];if(top)closeModal(top)}export function bindGlobalEsc(){on(document,'keydown',(e)=>{if(e.key==='Escape'){if(document.querySelector('.modal:not([hidden])')){e.stopPropagation();closeTopModal()}}})}