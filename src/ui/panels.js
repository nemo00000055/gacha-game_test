import{$,$$,on,openModal,closeModal,bindGlobalEsc}from'./dom.js';import{renderInventory,renderEquipment,renderShop,renderWaveInfo,renderTheme,setPressed}from'./render.js';export function setupUI(state,systems){bindGlobalEsc();renderWaveInfo(state);renderTheme(state);openModal($('#panel-selection'));on($('#btn-pause'),'click',()=>{state.auto.running=false;systems.pause();setPressed($('#btn-pause'),true)});on($('#btn-auto'),'click',()=>{state.auto.running=!state.auto.running;setPressed($('#btn-auto'),state.auto.running);systems.setAuto(state.auto.running)});on($('#btn-save-open'),'click',(e)=>{const m=$('#panel-save-load');if(!e.currentTarget.id)e.currentTarget.id='btn-save-open';openModal(m,e.currentTarget)});on(document,'keydown',(e)=>{const active=document.querySelector('.modal:not([hidden])');const inText=/input|textarea|select/.test((e.target.tagName||'').toLowerCase());if(inText)return;if(!active){if(e.code==='Space'){e.preventDefault();$('#btn-pause').click()}if(e.key.toLowerCase()==='a'){e.preventDefault();$('#btn-auto').click()}if(e.key.toLowerCase()==='i'){e.preventDefault();$('#btn-inventory').click()}if(e.key.toLowerCase()==='e'){e.preventDefault();$('#btn-equipment').click()}if(e.key.toLowerCase()==='s'){e.preventDefault();$('#btn-shop').click()}if(e.ctrlKey&&e.key.toLowerCase()==='s'){e.preventDefault();$('#btn-save').click()}if(e.ctrlKey&&e.key.toLowerCase()==='l'){e.preventDefault();$('#btn-load').click()}}});on($('#btn-inventory'),'click',(e)=>{openModal($('#panel-inventory'),e.currentTarget);renderInventory(state,'items');$('#btn-inv-tab').setAttribute('aria-selected','true');$('#btn-stash-tab').setAttribute('aria-selected','false')});on($('#btn-equipment'),'click',(e)=>{openModal($('#panel-equipment'),e.currentTarget);renderEquipment(state)});on($('#btn-shop'),'click',(e)=>{openModal($('#panel-shop'),e.currentTarget);renderShop(state,'weapons')});on($('#btn-inv-tab'),'click',()=>{$('#btn-inv-tab').setAttribute('aria-selected','true');$('#btn-stash-tab').setAttribute('aria-selected','false');renderInventory(state,'items')});on($('#btn-stash-tab'),'click',()=>{$('#btn-inv-tab').setAttribute('aria-selected','false');$('#btn-stash-tab').setAttribute('aria-selected','true');renderInventory(state,'stash')});for(const c of ['weapons','armor','consumables'])on($(`#tab-${c}`),'click',()=>renderShop(state,c));on($('#panel-shop'),'click',(e)=>{const t=e.target;if(!(t instanceof HTMLElement))return;if(t.dataset.sku){systems.buy(t.dataset.category,t.dataset.sku);renderShop(state,t.dataset.category)}if(t.dataset.bb){systems.buyback(t.dataset.bb);renderShop(state,$$('#shop-tabs [role="tab"][aria-selected="true"]')[0]?.id.replace('tab-','')||'weapons')}});on($('#btn-save'),'click',async()=>{const ok=await systems.save();$('#save-status').textContent=ok?'Game saved.':'Save failed.'});on($('#btn-load'),'click',async()=>{const ok=await systems.load();$('#save-status').textContent=ok?'Game loaded.':'Load failed.';if(ok){renderWaveInfo(state);renderTheme(state)}});on($('#panel-selection'),'change',(e)=>{if(e.target.name==='side')$('#btn-start').disabled=false});on($('#btn-random-pick'),'click',()=>{const c=$$('#panel-selection input[name="side"]');const pick=Math.random()<0.5?'hero':'creature';c.forEach(r=>{r.checked=(r.value===pick)});$('#btn-start').disabled=false});on($('#btn-start'),'click',()=>{const sel=$('#panel-selection input[name="side"]:checked');if(!sel)return;systems.start(sel.value);renderWaveInfo(state);renderTheme(state);closeModal($('#panel-selection'))});}